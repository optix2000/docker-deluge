From 0f919b7e78ffb3514bf85d38553e94700fceb7fd Mon Sep 17 00:00:00 2001
From: tbkizle <tbkizle@gmail.com>
Date: Sat, 15 Jan 2022 05:50:38 -0500
Subject: [PATCH] Mutli-Homing

---
 deluge/common.py                              | 60 ++++---------------
 deluge/core/preferencesmanager.py             | 27 +++++++--
 .../js/deluge-all/preferences/NetworkPage.js  | 18 ++----
 3 files changed, 38 insertions(+), 67 deletions(-)

diff --git a/deluge/common.py b/deluge/common.py
index ecf90a390..7004b82b9 100644
--- a/deluge/common.py
+++ b/deluge/common.py
@@ -966,11 +966,13 @@ def is_ipv4(ip):
     """
 
     try:
-        socket.inet_pton(socket.AF_INET, ip)
-    except OSError:
-        return False
-    else:
+        for interface in ip.split(','):
+            socket.inet_pton(socket.AF_INET, interface)
         return True
+    except OSError:
+        log.warning('Unable to verify IPv6 Address with socket.')
+
+    return False
 
 
 def is_ipv6(ip):
@@ -988,52 +990,16 @@ def is_ipv6(ip):
 
     """
 
+    import socket
+
     try:
-        socket.inet_pton(socket.AF_INET6, ip)
-    except OSError:
-        return False
-    else:
+        for interface in ip.split(','):
+            socket.inet_pton(socket.AF_INET6, interface)
         return True
+    except OSError:
+        log.warning('Unable to verify IPv6 Address with socket.')
 
-
-def is_interface_name(name):
-    """Returns True if an interface name exists.
-
-    Args:
-        name (str): The Interface to test. eg. eth0 linux. GUID on Windows.
-
-    Returns:
-        bool: Whether name is valid or not.
-
-    Examples:
-        >>> is_interface_name("eth0")
-        True
-        >>> is_interface_name("{7A30AE62-23ZA-3744-Z844-A5B042524871}")
-        True
-
-    """
-
-    if not windows_check():
-        try:
-            socket.if_nametoindex(name)
-        except OSError:
-            pass
-        else:
-            return True
-
-    if ifaddr:
-        try:
-            adapters = ifaddr.get_adapters()
-        except OSError:
-            return True
-        else:
-            return any([name == a.name for a in adapters])
-
-    if windows_check():
-        regex = '^{[0-9A-Z]{8}-([0-9A-Z]{4}-){3}[0-9A-Z]{12}}$'
-        return bool(re.search(regex, str(name)))
-
-    return True
+    return False
 
 
 def decode_bytes(byte_str, encoding='utf8'):
diff --git a/deluge/core/preferencesmanager.py b/deluge/core/preferencesmanager.py
index 7e5c207a1..32c7e12d4 100644
--- a/deluge/core/preferencesmanager.py
+++ b/deluge/core/preferencesmanager.py
@@ -210,24 +210,39 @@ def __set_listen_on(self):
             listen_ports = self.config['listen_ports']
 
         if self.config['listen_interface']:
-            interface = self.config['listen_interface'].strip()
+            interfaces = self.config['listen_interface'].strip()
         else:
-            interface = '0.0.0.0'
+            interfaces = '0.0.0.0'
+
+        lib_interfaces = []
+        for interface in interfaces.split(','):
+            interface = interface.strip()
+            try:
+                # add square brackets to ipv6 only, as needed by lib torrent
+                lib_interfaces.append(
+                    '[' + interface + ']'
+                    if deluge.common.is_ipv6(interface)
+                    else interface
+                )
+            except ValueError:
+                # ip address format failed, assume network interface name
+                lib_interfaces.append(interface)
 
         log.debug(
             'Listen Interface: %s, Ports: %s with use_sys_port: %s',
-            interface,
+            lib_interfaces,
             listen_ports,
             self.config['listen_use_sys_port'],
         )
-        interfaces = [
-            f'{interface}:{port}'
+        interface_port_list = [
+            f'{lib_interfaces}:{port}'
             for port in range(listen_ports[0], listen_ports[1] + 1)
+            for lib_interface in lib_interfaces
         ]
         self.core.apply_session_settings(
             {
                 'listen_system_port_fallback': self.config['listen_use_sys_port'],
-                'listen_interfaces': ','.join(interfaces),
+                'listen_interfaces': ','.join(interface_port_list),
             }
         )
 
-- 
2.39.5

